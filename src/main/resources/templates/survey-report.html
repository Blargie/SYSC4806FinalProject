<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{navbar :: navbar}"></div>

    <div class="container mt-5">
        <h1 class="mb-4">Survey Report</h1>
        <div class="card mb-4">
            <div class="card-body">
                <h2 id="survey-title" class="card-title"></h2>
                <p id="survey-description" class="text-muted"></p>
                <div id="questions-container"></div>
            </div>
        </div>

        <button class="btn btn-secondary" onclick="window.location.href='/api/surveys/survey-list-admin'">
            Back to View Surveys
        </button>
    </div>

    <script>
        const surveyId = window.location.pathname.split("/")[3];

        async function fetchAnswers(questionId) {
            const response = await fetch(`/api/surveys/${surveyId}/answers/${questionId}`);
            return response.json();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch survey details
                const surveyResponse = await fetch(`/api/surveys/${surveyId}`);
                const survey = await surveyResponse.json();
                
                document.getElementById('survey-title').textContent = survey.surveyName;
                document.getElementById('survey-description').textContent = survey.surveyDescription;
                
                const questionsContainer = document.getElementById('questions-container');
                
                // Process each question and its answers
                for (const question of survey.surveyQuestions) {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'card mb-3';
                    
                    // Fetch answers for this question
                    const answers = await fetchAnswers(question.questionId);
                    
                    let answersHtml = '';
                    if (answers && answers.length > 0) {
                        answersHtml = `
                            <div class="answer-list mt-3">
                                <h6>Responses:</h6>
                                <ul class="list-group">
                                    ${answers.map(answer => `
                                        <li class="list-group-item">
                                            ${!survey.isAnonymous && answer.userId ? 
                                                `<strong>User ${answer.userId}:</strong> ` : 
                                                '<strong>Anonymous:</strong> '}
                                            ${formatAnswer(answer, question)}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    questionDiv.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${question.questionText}</h5>
                            <p class="card-text">
                                <small class="text-muted">Type: ${question.type}</small>
                                ${question.required ? '<span class="badge bg-danger ms-2">Required</span>' : ''}
                            </p>
                            ${answersHtml}
                        </div>
                    `;
                    
                    questionsContainer.appendChild(questionDiv);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading survey report');
            }
        });

        function formatAnswer(answer, question) {
            switch (question.type) {
                case 'TEXT':
                    return answer.text;
                case 'MULTIPLE_CHOICE':
                    return `Option ${answer.selectedChoice + 1}: ${question.options[answer.selectedChoice]}`;
                case 'NUMERIC_RANGE':
                    return `Value: ${answer.choice}`;
                default:
                    return 'Unknown answer type';
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>